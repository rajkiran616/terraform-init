# Terraform Configuration Generation Scripts\n\nThis directory contains powerful shell scripts that automatically generate Terraform module configurations from your existing AWS resources. These scripts scan your AWS account and create the JSON-like configuration objects required by our for_each pattern modules.\n\n## üöÄ Quick Start\n\n### Generate All Configurations\n```bash\n# Generate configurations for all modules\n./scripts/generate-all-configs.sh\n\n# Generate for specific VPC only\n./scripts/generate-all-configs.sh --vpc-id vpc-12345678\n\n# Dry run to see what would be generated\n./scripts/generate-all-configs.sh --dry-run\n```\n\n### Generate Individual Module Configurations\n```bash\n# Generate IAM configuration\n./scripts/generate-iam-config.sh -o my-iam.tf\n\n# Generate VPC configuration for specific VPC\n./scripts/generate-vpc-config.sh --vpc-id vpc-12345678 -o my-vpc.tf\n\n# Generate Security Groups configuration\n./scripts/generate-sg-config.sh --vpc-id vpc-12345678 -o my-sg.tf\n```\n\n## üìã Prerequisites\n\n### Required Tools\n- **AWS CLI** - Configured with appropriate credentials\n- **jq** - JSON processor\n  - macOS: `brew install jq`\n  - Ubuntu/Debian: `apt-get install jq`\n  - Amazon Linux: `yum install jq`\n\n### AWS Permissions\nYour AWS credentials need read access to:\n- IAM (policies, roles, users, groups)\n- EC2 (VPCs, subnets, security groups, route tables, etc.)\n- All resources you want to import\n\n## üìÅ Available Scripts\n\n### 1. Master Script: `generate-all-configs.sh`\n\nOrchestrates all other scripts to generate complete infrastructure configurations.\n\n**Usage:**\n```bash\n./generate-all-configs.sh [OPTIONS]\n```\n\n**Key Options:**\n- `-d, --output-dir DIR` - Output directory (default: generated-configs)\n- `-r, --region REGION` - AWS region to scan\n- `-v, --vpc-id VPC_ID` - Specific VPC ID to focus on\n- `-f, --filter PATTERN` - Filter resources by name pattern\n- `-e, --exclude PATTERN` - Exclude resources by name pattern\n- `--include-defaults` - Include default VPCs/Security Groups\n- `--iam-only` - Generate only IAM configuration\n- `--vpc-only` - Generate only VPC configuration\n- `--sg-only` - Generate only Security Group configuration\n- `--dry-run` - Preview without creating files\n\n**Examples:**\n```bash\n# Generate all configurations for production resources\n./generate-all-configs.sh -f \"prod-*\" -e \"*test*\" -d prod-configs\n\n# Generate only VPC configuration for specific VPC\n./generate-all-configs.sh --vpc-only --vpc-id vpc-12345678\n\n# Dry run to preview what would be generated\n./generate-all-configs.sh --dry-run --include-defaults\n```\n\n### 2. IAM Script: `generate-iam-config.sh`\n\nGenerates IAM module configurations from existing IAM resources.\n\n**Features:**\n- Policies (custom and AWS managed)\n- Roles with assume role policies\n- Inline policies\n- Users and groups\n- Policy attachments\n- Group memberships\n\n**Usage:**\n```bash\n./generate-iam-config.sh [OPTIONS]\n```\n\n**Key Options:**\n- `-o, --output FILE` - Output file (default: iam-config.tf)\n- `-f, --filter PATTERN` - Filter by resource name pattern\n- `-e, --exclude PATTERN` - Exclude by name pattern\n- `--policies-only` - Generate only policies\n- `--roles-only` - Generate only roles\n- `--users-only` - Generate only users\n- `--include-aws-managed` - Include AWS managed policies\n- `--dry-run` - Preview without creating files\n\n**Examples:**\n```bash\n# Generate all IAM resources\n./generate-iam-config.sh -o production-iam.tf\n\n# Generate only application-related roles\n./generate-iam-config.sh --roles-only -f \"app-*\" -o app-roles.tf\n\n# Include AWS managed policies\n./generate-iam-config.sh --include-aws-managed\n```\n\n### 3. VPC Script: `generate-vpc-config.sh`\n\nGenerates VPC module configurations from existing network resources.\n\n**Features:**\n- VPCs with DNS settings\n- Public/private/database subnets\n- Internet Gateways\n- NAT Gateways and Elastic IPs\n- Route Tables and associations\n- VPC Endpoints\n\n**Usage:**\n```bash\n./generate-vpc-config.sh [OPTIONS]\n```\n\n**Key Options:**\n- `-o, --output FILE` - Output file (default: vpc-config.tf)\n- `-r, --region REGION` - AWS region to scan\n- `-v, --vpc-id VPC_ID` - Specific VPC ID to scan\n- `-f, --filter PATTERN` - Filter by resource name pattern\n- `-e, --exclude PATTERN` - Exclude by name pattern\n- `--include-default-vpc` - Include default VPC\n- `--dry-run` - Preview without creating files\n\n**Examples:**\n```bash\n# Generate configuration for specific VPC\n./generate-vpc-config.sh --vpc-id vpc-12345678 -o prod-vpc.tf\n\n# Generate for all production VPCs in us-west-2\n./generate-vpc-config.sh -r us-west-2 -f \"prod-*\" -o prod-networking.tf\n\n# Include default VPC (usually not recommended)\n./generate-vpc-config.sh --include-default-vpc\n```\n\n### 4. Security Groups Script: `generate-sg-config.sh`\n\nGenerates Security Groups module configurations from existing security groups.\n\n**Features:**\n- Security Groups with descriptions\n- Ingress and egress rules\n- CIDR block rules\n- Security group cross-references\n- Comprehensive rule mapping\n\n**Usage:**\n```bash\n./generate-sg-config.sh [OPTIONS]\n```\n\n**Key Options:**\n- `-o, --output FILE` - Output file (default: sg-config.tf)\n- `-r, --region REGION` - AWS region to scan\n- `-v, --vpc-id VPC_ID` - Specific VPC ID to scan\n- `-g, --group-id SG_ID` - Specific Security Group ID\n- `-f, --filter PATTERN` - Filter by resource name pattern\n- `-e, --exclude PATTERN` - Exclude by name pattern\n- `--include-default` - Include default security groups\n- `--dry-run` - Preview without creating files\n\n**Examples:**\n```bash\n# Generate for specific VPC\n./generate-sg-config.sh --vpc-id vpc-12345678 -o vpc-security-groups.tf\n\n# Generate for specific security group\n./generate-sg-config.sh --group-id sg-12345678 -o web-sg.tf\n\n# Generate for web-tier security groups\n./generate-sg-config.sh -f \"web-*\" -o web-security-groups.tf\n```\n\n## üìä Generated Output Structure\n\nWhen you run `generate-all-configs.sh`, it creates:\n\n```\ngenerated-configs/\n‚îú‚îÄ‚îÄ iam-config.tf              # IAM resources configuration\n‚îú‚îÄ‚îÄ vpc-config.tf              # VPC resources configuration\n‚îú‚îÄ‚îÄ sg-config.tf               # Security Groups configuration\n‚îú‚îÄ‚îÄ import-commands.sh         # Template import commands\n‚îî‚îÄ‚îÄ generation-summary.md      # Summary report\n```\n\n### Generated Terraform Configuration\n\nThe scripts generate Terraform configurations using our for_each pattern:\n\n```hcl\nmodule \"imported_iam\" {\n  source = \"./modules/iam-management\"\n\n  # IAM Policies\n  iam_policies = {\n    \"s3-read-policy\" = {\n      name            = \"S3ReadOnlyPolicy\"\n      description     = \"Read-only access to S3\"\n      policy_document = jsonencode({...})\n      tags = {\n        ImportedBy = \"terraform-script\"\n        Environment = \"existing\"\n      }\n    }\n  }\n\n  # IAM Roles\n  iam_roles = {\n    \"app-server-role\" = {\n      name               = \"AppServerRole\"\n      assume_role_policy = jsonencode({...})\n      tags = {\n        ImportedBy = \"terraform-script\"\n      }\n    }\n  }\n\n  # Policy Attachments\n  iam_role_policy_attachments = {\n    \"app-server-s3-access\" = {\n      role_key   = \"app-server-role\"\n      policy_key = \"s3-read-policy\"\n    }\n  }\n}\n```\n\n## üîß Configuration Patterns\n\n### Resource Naming and Keys\n- **Sanitized Keys**: Resource names are converted to Terraform-friendly keys\n- **Cross-References**: Resources reference each other using keys\n- **Flexible References**: Support both module-internal and external resource references\n\n### Tag Management\n- **Preserved Tags**: Existing resource tags are preserved\n- **Import Tags**: Special tags added to track imported resources\n- **Common Tags**: Consistent tagging across all resources\n\n### Environment Handling\n- **Multi-Region**: Support for scanning different regions\n- **Multi-Account**: Works across different AWS accounts\n- **Filtering**: Flexible filtering by name patterns\n\n## üìù Workflow Example\n\nHere's a complete workflow for importing existing infrastructure:\n\n### 1. Generate Configurations\n```bash\n# Generate all configurations\n./scripts/generate-all-configs.sh -d production-import\n```\n\n### 2. Review Generated Files\n```bash\n# Check what was generated\nls -la production-import/\n\n# Review the configurations\ncat production-import/generation-summary.md\n```\n\n### 3. Customize Import Commands\n```bash\n# Edit the import commands with actual resource IDs\nvim production-import/import-commands.sh\n```\n\n### 4. Place Configuration Files\n```bash\n# Copy to your Terraform project\ncp production-import/*.tf ./\n```\n\n### 5. Initialize and Import\n```bash\n# Initialize Terraform\nterraform init\n\n# Run import commands\n./production-import/import-commands.sh\n\n# Verify everything looks good\nterraform plan\n```\n\n## üéØ Best Practices\n\n### Pre-Generation\n- **Inventory Resources**: Know what you want to import\n- **Test Environment**: Try on non-production first\n- **Backup**: Document current infrastructure state\n\n### During Generation\n- **Use Filters**: Focus on specific resource groups\n- **Dry Run First**: Always preview before generating\n- **Check Permissions**: Ensure adequate AWS access\n\n### Post-Generation\n- **Review Configurations**: Check all generated .tf files\n- **Validate References**: Ensure cross-resource references are correct\n- **Test Imports**: Start with less critical resources\n- **Verify State**: Use `terraform plan` to check for drift\n\n### Security Considerations\n- **Sensitive Data**: Scripts don't expose secrets in plain text\n- **Access Keys**: Generated configurations reference existing resources safely\n- **Policy Documents**: Review generated policies for correctness\n\n## üîç Troubleshooting\n\n### Common Issues\n\n**1. Permission Denied**\n```bash\n# Make scripts executable\nchmod +x scripts/*.sh\n```\n\n**2. AWS CLI Not Configured**\n```bash\n# Configure AWS CLI\naws configure\n# or\nexport AWS_PROFILE=your-profile\n```\n\n**3. jq Not Found**\n```bash\n# Install jq\nbrew install jq  # macOS\nsudo apt-get install jq  # Ubuntu\n```\n\n**4. No Resources Found**\n- Check region settings\n- Verify AWS permissions\n- Review filter/exclude patterns\n- Confirm resources exist\n\n**5. Import Failures**\n- Verify resource IDs in import commands\n- Check Terraform configuration syntax\n- Ensure resource references are correct\n- Review AWS permissions\n\n### Debug Mode\n\nAll scripts support verbose output:\n```bash\n# Run with debug information\nbash -x ./generate-all-configs.sh --dry-run\n```\n\n### Getting Help\n\nEach script has built-in help:\n```bash\n./generate-all-configs.sh --help\n./generate-iam-config.sh --help\n./generate-vpc-config.sh --help\n./generate-sg-config.sh --help\n```\n\n## üöÄ Advanced Usage\n\n### Multi-Account Setup\n\n```bash\n# Generate for different accounts using profiles\nAWS_PROFILE=dev-account ./generate-all-configs.sh -d dev-configs\nAWS_PROFILE=prod-account ./generate-all-configs.sh -d prod-configs\n```\n\n### Multi-Region Setup\n\n```bash\n# Generate for multiple regions\n./generate-all-configs.sh -r us-east-1 -d us-east-1-configs\n./generate-all-configs.sh -r us-west-2 -d us-west-2-configs\n```\n\n### Large Scale Imports\n\n```bash\n# Break down by service/tier\n./generate-all-configs.sh -f \"web-*\" -d web-tier\n./generate-all-configs.sh -f \"api-*\" -d api-tier\n./generate-all-configs.sh -f \"db-*\" -d database-tier\n```\n\n### Custom Integration\n\nThe scripts can be integrated into CI/CD pipelines:\n\n```bash\n#!/bin/bash\n# Pipeline script\nset -e\n\n# Generate configurations\n./scripts/generate-all-configs.sh --vpc-id \"$VPC_ID\" -d \"import-configs\"\n\n# Validate generated configurations\nterraform fmt -check import-configs/\nterraform validate import-configs/\n\n# Create PR with generated configurations\n# ... your PR creation logic\n```\n\nThese scripts provide a powerful foundation for migrating existing AWS infrastructure to Terraform using our modular, for_each pattern approach. They save hours of manual work and reduce errors in the import process."