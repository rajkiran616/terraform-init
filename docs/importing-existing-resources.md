# Importing Existing AWS Resources\n\nThis guide explains how to import existing AWS resources into your Terraform configuration using the for_each pattern modules.\n\n## Overview\n\nThe for_each pattern design makes it easy to import existing resources because:\n- Each resource has a unique key in the configuration\n- Resources are created independently with `for_each`\n- You can import resources one at a time\n- The configuration structure matches AWS resource relationships\n\n## General Import Process\n\n1. **Identify existing resources** - List all resources you want to import\n2. **Create configuration** - Define the resources in your Terraform configuration\n3. **Import resources** - Use `terraform import` to bring them under Terraform management\n4. **Validate configuration** - Run `terraform plan` to ensure no changes are needed\n\n## Importing VPC Resources\n\n### Step 1: Identify Existing VPC Resources\n\n```bash\n# List VPCs\naws ec2 describe-vpcs --query 'Vpcs[*].{VpcId:VpcId,CidrBlock:CidrBlock,Tags:Tags}' --output table\n\n# List subnets\naws ec2 describe-subnets --query 'Subnets[*].{SubnetId:SubnetId,VpcId:VpcId,CidrBlock:CidrBlock,AvailabilityZone:AvailabilityZone,Tags:Tags}' --output table\n\n# List internet gateways\naws ec2 describe-internet-gateways --query 'InternetGateways[*].{InternetGatewayId:InternetGatewayId,Attachments:Attachments,Tags:Tags}' --output table\n\n# List NAT gateways\naws ec2 describe-nat-gateways --query 'NatGateways[*].{NatGatewayId:NatGatewayId,VpcId:VpcId,SubnetId:SubnetId,State:State,Tags:Tags}' --output table\n\n# List route tables\naws ec2 describe-route-tables --query 'RouteTables[*].{RouteTableId:RouteTableId,VpcId:VpcId,Routes:Routes,Associations:Associations,Tags:Tags}' --output table\n```\n\n### Step 2: Create VPC Configuration\n\nCreate a configuration file based on your existing resources:\n\n```hcl\n# vpc-import.tf\nmodule \"existing_network\" {\n  source = \"./modules/vpc\"\n\n  vpcs = {\n    \"production-vpc\" = {\n      cidr_block           = \"10.1.0.0/16\"  # Match existing VPC\n      enable_dns_hostnames = true\n      enable_dns_support   = true\n      tags = {\n        Name        = \"production-vpc\"\n        Environment = \"prod\"\n      }\n    }\n  }\n\n  internet_gateways = {\n    \"production-igw\" = {\n      vpc_key = \"production-vpc\"\n      tags = {\n        Name = \"production-igw\"\n      }\n    }\n  }\n\n  subnets = {\n    \"public-subnet-1a\" = {\n      vpc_key                 = \"production-vpc\"\n      cidr_block              = \"10.1.1.0/24\"  # Match existing subnet\n      availability_zone       = \"us-west-2a\"   # Match existing AZ\n      map_public_ip_on_launch = true\n      tier                    = \"public\"\n      tags = {\n        Name = \"public-subnet-1a\"\n      }\n    }\n    # Add more subnets as needed...\n  }\n\n  # Add other resources (route tables, NAT gateways, etc.)\n}\n```\n\n### Step 3: Import VPC Resources\n\n```bash\n# Import VPC\nterraform import 'module.existing_network.aws_vpc.this[\"production-vpc\"]' vpc-12345678\n\n# Import Internet Gateway\nterraform import 'module.existing_network.aws_internet_gateway.this[\"production-igw\"]' igw-12345678\n\n# Import Subnets\nterraform import 'module.existing_network.aws_subnet.this[\"public-subnet-1a\"]' subnet-12345678\nterraform import 'module.existing_network.aws_subnet.this[\"private-subnet-1a\"]' subnet-87654321\n\n# Import NAT Gateways\nterraform import 'module.existing_network.aws_nat_gateway.this[\"nat-gw-1a\"]' nat-12345678\n\n# Import Elastic IPs\nterraform import 'module.existing_network.aws_eip.this[\"nat-eip-1a\"]' eipalloc-12345678\n\n# Import Route Tables\nterraform import 'module.existing_network.aws_route_table.this[\"public-rt\"]' rtb-12345678\nterraform import 'module.existing_network.aws_route_table.this[\"private-rt-1a\"]' rtb-87654321\n\n# Import Route Table Associations\nterraform import 'module.existing_network.aws_route_table_association.this[\"public-subnet-1a-assoc\"]' subnet-12345678/rtb-12345678\n```\n\n## Importing Security Group Resources\n\n### Step 1: Identify Existing Security Groups\n\n```bash\n# List security groups\naws ec2 describe-security-groups --query 'SecurityGroups[*].{GroupId:GroupId,GroupName:GroupName,Description:Description,VpcId:VpcId,Tags:Tags}' --output table\n\n# Get detailed rules for a specific security group\naws ec2 describe-security-groups --group-ids sg-12345678 --query 'SecurityGroups[0].{IpPermissions:IpPermissions,IpPermissionsEgress:IpPermissionsEgress}'\n```\n\n### Step 2: Create Security Group Configuration\n\n```hcl\n# security-groups-import.tf\nmodule \"existing_security_groups\" {\n  source = \"./modules/security-groups\"\n\n  security_groups = {\n    \"web-server-sg\" = {\n      name        = \"web-server-sg\"  # Match existing name\n      description = \"Security group for web servers\"\n      vpc_id      = \"vpc-12345678\"  # Use actual VPC ID or reference\n      tags = {\n        Name = \"web-server-sg\"\n      }\n    }\n  }\n\n  security_group_rules = {\n    \"web-http-ingress\" = {\n      security_group_key = \"web-server-sg\"\n      type               = \"ingress\"\n      from_port          = 80\n      to_port            = 80\n      protocol           = \"tcp\"\n      description        = \"HTTP from anywhere\"\n      cidr_blocks        = [\"0.0.0.0/0\"]\n    }\n    # Add more rules to match existing configuration\n  }\n}\n```\n\n### Step 3: Import Security Group Resources\n\n```bash\n# Import Security Group\nterraform import 'module.existing_security_groups.aws_security_group.this[\"web-server-sg\"]' sg-12345678\n\n# Import Security Group Rules\nterraform import 'module.existing_security_groups.aws_security_group_rule.this[\"web-http-ingress\"]' sg-12345678_ingress_tcp_80_80_0.0.0.0/0\n```\n\n## Import Strategies\n\n### 1. Incremental Import\nImport resources in logical groups:\n1. Core networking (VPC, IGW)\n2. Subnets\n3. Routing (Route Tables, NAT Gateways)\n4. Security Groups\n5. Applications resources\n\n### 2. Environment-by-Environment\nImport one environment at a time:\n1. Production first (most critical)\n2. Staging\n3. Development\n\n### 3. Service-by-Service\nImport by service or application:\n1. Shared networking\n2. Database infrastructure\n3. Application infrastructure\n\n## Best Practices\n\n### 1. Documentation\n- Document existing resource relationships\n- Keep track of imported resources\n- Note any configuration differences\n\n### 2. Validation\n```bash\n# After each import, verify no unwanted changes\nterraform plan\n\n# Check for configuration drift\nterraform refresh\nterraform plan\n```\n\n### 3. Backup\n- Export current configurations before import\n- Have rollback procedures ready\n- Test imports in non-production first\n\n### 4. Resource Naming\n- Use consistent naming conventions\n- Match existing resource names where possible\n- Use descriptive keys in your configuration\n\n## Troubleshooting Common Issues\n\n### 1. Import Errors\n```bash\n# If import fails, check resource exists\naws ec2 describe-vpcs --vpc-ids vpc-12345678\n\n# Check exact resource ID format\naws ec2 describe-security-group-rules --group-ids sg-12345678\n```\n\n### 2. Configuration Mismatches\nAfter import, if `terraform plan` shows changes:\n- Update configuration to match existing resource\n- Consider if the change is desired\n- Use `terraform show` to see current state\n\n### 3. Dependency Issues\nImport resources in dependency order:\n1. VPC before subnets\n2. Internet Gateway before route tables\n3. Security Groups before rules\n\n## Example Import Script\n\nCreate a script to automate imports:\n\n```bash\n#!/bin/bash\n# import-vpc.sh\n\nset -e\n\necho \"Importing VPC resources...\"\n\n# VPC\nterraform import 'module.network.aws_vpc.this[\"main-vpc\"]' vpc-12345678\n\n# Internet Gateway\nterraform import 'module.network.aws_internet_gateway.this[\"main-igw\"]' igw-12345678\n\n# Subnets\nterraform import 'module.network.aws_subnet.this[\"public-1a\"]' subnet-12345678\nterraform import 'module.network.aws_subnet.this[\"private-1a\"]' subnet-87654321\n\necho \"Import completed. Running terraform plan...\"\nterraform plan\n```\n\n## Post-Import Checklist\n\n- [ ] All resources imported successfully\n- [ ] `terraform plan` shows no unwanted changes\n- [ ] Configuration matches existing infrastructure\n- [ ] Tags are properly configured\n- [ ] Dependencies are correctly defined\n- [ ] Documentation updated\n- [ ] Team notified of changes\n\n## Migration Timeline\n\nFor large environments, plan your migration:\n\n**Week 1**: Planning and documentation\n- Inventory existing resources\n- Design new configuration structure\n- Create import scripts\n\n**Week 2**: Core infrastructure\n- Import VPCs and networking\n- Validate configuration\n\n**Week 3**: Security and routing\n- Import security groups\n- Import routing components\n- Test connectivity\n\n**Week 4**: Applications and services\n- Import application resources\n- Validate end-to-end functionality\n- Documentation and training\n\nThis approach ensures a smooth transition to Infrastructure as Code while maintaining the flexibility to import existing resources efficiently."