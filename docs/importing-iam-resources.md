# Importing IAM Resources\n\nThis guide explains how to import existing IAM resources into your Terraform configuration using the refactored IAM management module.\n\n## Overview\n\nThe IAM module's for_each pattern makes importing existing IAM resources straightforward because:\n- Each resource type has a dedicated configuration map\n- Resources are referenced by keys, making imports predictable\n- Policy attachments can reference both existing and newly created resources\n- Cross-references between resources are handled automatically\n\n## IAM Import Commands Reference\n\n### Policies\n```bash\n# Import IAM Policy\nterraform import 'module.iam_management.aws_iam_policy.this[\"my-policy-key\"]' arn:aws:iam::123456789012:policy/MyExistingPolicy\n```\n\n### Roles\n```bash\n# Import IAM Role\nterraform import 'module.iam_management.aws_iam_role.this[\"my-role-key\"]' MyExistingRole\n```\n\n### Users\n```bash\n# Import IAM User\nterraform import 'module.iam_management.aws_iam_user.this[\"my-user-key\"]' MyExistingUser\n```\n\n### Groups\n```bash\n# Import IAM Group\nterraform import 'module.iam_management.aws_iam_group.this[\"my-group-key\"]' MyExistingGroup\n```\n\n### Instance Profiles\n```bash\n# Import IAM Instance Profile\nterraform import 'module.iam_management.aws_iam_instance_profile.this[\"my-profile-key\"]' MyExistingInstanceProfile\n```\n\n### Policy Attachments\n```bash\n# Import Role Policy Attachment\nterraform import 'module.iam_management.aws_iam_role_policy_attachment.this[\"my-attachment-key\"]' MyRoleName/arn:aws:iam::123456789012:policy/MyPolicy\n\n# Import User Policy Attachment\nterraform import 'module.iam_management.aws_iam_user_policy_attachment.this[\"my-attachment-key\"]' MyUserName/arn:aws:iam::123456789012:policy/MyPolicy\n\n# Import Group Policy Attachment\nterraform import 'module.iam_management.aws_iam_group_policy_attachment.this[\"my-attachment-key\"]' MyGroupName/arn:aws:iam::123456789012:policy/MyPolicy\n```\n\n### Group Memberships\n```bash\n# Import Group Membership\nterraform import 'module.iam_management.aws_iam_group_membership.this[\"my-membership-key\"]' MyMembershipName\n```\n\n### Access Keys\n```bash\n# Import Access Key\nterraform import 'module.iam_management.aws_iam_access_key.this[\"my-key\"]' MyUserName:AKIAIOSFODNN7EXAMPLE\n```\n\n### SAML/OIDC Providers\n```bash\n# Import SAML Provider\nterraform import 'module.iam_management.aws_iam_saml_provider.this[\"my-saml-provider\"]' arn:aws:iam::123456789012:saml-provider/MyProvider\n\n# Import OIDC Provider\nterraform import 'module.iam_management.aws_iam_openid_connect_provider.this[\"my-oidc-provider\"]' arn:aws:iam::123456789012:oidc-provider/token.actions.githubusercontent.com\n```\n\n## Step-by-Step Import Process\n\n### Step 1: Inventory Existing IAM Resources\n\n```bash\n#!/bin/bash\n# Script to inventory existing IAM resources\n\necho \"=== IAM Policies ===\"\naws iam list-policies --scope Local --query 'Policies[*].{PolicyName:PolicyName,Arn:Arn,Description:Description}' --output table\n\necho \"\\n=== IAM Roles ===\"\naws iam list-roles --query 'Roles[*].{RoleName:RoleName,Arn:Arn,Description:Description}' --output table\n\necho \"\\n=== IAM Users ===\"\naws iam list-users --query 'Users[*].{UserName:UserName,Arn:Arn,Path:Path}' --output table\n\necho \"\\n=== IAM Groups ===\"\naws iam list-groups --query 'Groups[*].{GroupName:GroupName,Arn:Arn,Path:Path}' --output table\n\necho \"\\n=== IAM Instance Profiles ===\"\naws iam list-instance-profiles --query 'InstanceProfiles[*].{InstanceProfileName:InstanceProfileName,Arn:Arn,Roles:Roles[*].RoleName}' --output table\n```\n\n### Step 2: Get Detailed Resource Information\n\n```bash\n# Get policy document for a specific policy\naws iam get-policy --policy-arn arn:aws:iam::123456789012:policy/MyPolicy\naws iam get-policy-version --policy-arn arn:aws:iam::123456789012:policy/MyPolicy --version-id v1\n\n# Get role details and assume role policy\naws iam get-role --role-name MyRole\n\n# Get attached policies for a role\naws iam list-attached-role-policies --role-name MyRole\naws iam list-role-policies --role-name MyRole  # inline policies\n\n# Get group memberships\naws iam get-group --group-name MyGroup\n\n# Get user details\naws iam get-user --user-name MyUser\naws iam list-attached-user-policies --user-name MyUser\n```\n\n### Step 3: Create Configuration\n\nCreate your Terraform configuration based on the existing resources:\n\n```hcl\n# iam-import.tf\nmodule \"imported_iam\" {\n  source = \"./modules/iam-management\"\n\n  # Import existing policies\n  iam_policies = {\n    \"s3-access-policy\" = {\n      name        = \"MyExistingS3Policy\"  # Match existing name\n      description = \"Existing S3 access policy\"\n      policy_document = jsonencode({\n        # Copy the existing policy document here\n        Version = \"2012-10-17\"\n        Statement = [\n          # ... existing statements\n        ]\n      })\n      tags = {\n        Environment = \"prod\"\n        ImportedBy  = \"terraform\"\n      }\n    }\n  }\n\n  # Import existing roles\n  iam_roles = {\n    \"ec2-role\" = {\n      name        = \"MyExistingEC2Role\"  # Match existing name\n      description = \"Existing EC2 role\"\n      assume_role_policy = jsonencode({\n        # Copy the existing assume role policy here\n        Version = \"2012-10-17\"\n        Statement = [\n          # ... existing statements\n        ]\n      })\n      tags = {\n        Environment = \"prod\"\n        ImportedBy  = \"terraform\"\n      }\n    }\n  }\n\n  # Import existing users\n  iam_users = {\n    \"service-user\" = {\n      name = \"MyExistingServiceUser\"  # Match existing name\n      path = \"/service-users/\"         # Match existing path\n      tags = {\n        Environment = \"prod\"\n        ImportedBy  = \"terraform\"\n      }\n    }\n  }\n\n  # Import existing policy attachments\n  iam_role_policy_attachments = {\n    \"ec2-role-s3-access\" = {\n      role_key   = \"ec2-role\"         # Reference to role above\n      policy_key = \"s3-access-policy\" # Reference to policy above\n    }\n    \"ec2-role-aws-managed\" = {\n      role_key   = \"ec2-role\"\n      policy_arn = \"arn:aws:iam::aws:policy/AmazonEC2ReadOnlyAccess\"  # AWS managed policy\n    }\n  }\n\n  common_tags = {\n    Project     = \"terraform-multi-account-organization\"\n    ManagedBy   = \"terraform\"\n    ImportedBy  = \"terraform-import\"\n  }\n}\n```\n\n### Step 4: Execute Imports\n\n```bash\n#!/bin/bash\n# import-iam.sh\n\nset -e\n\necho \"Starting IAM resource imports...\"\n\n# Import policies\necho \"Importing IAM policies...\"\nterraform import 'module.imported_iam.aws_iam_policy.this[\"s3-access-policy\"]' arn:aws:iam::123456789012:policy/MyExistingS3Policy\n\n# Import roles\necho \"Importing IAM roles...\"\nterraform import 'module.imported_iam.aws_iam_role.this[\"ec2-role\"]' MyExistingEC2Role\n\n# Import users\necho \"Importing IAM users...\"\nterraform import 'module.imported_iam.aws_iam_user.this[\"service-user\"]' MyExistingServiceUser\n\n# Import policy attachments\necho \"Importing policy attachments...\"\nterraform import 'module.imported_iam.aws_iam_role_policy_attachment.this[\"ec2-role-s3-access\"]' MyExistingEC2Role/arn:aws:iam::123456789012:policy/MyExistingS3Policy\nterraform import 'module.imported_iam.aws_iam_role_policy_attachment.this[\"ec2-role-aws-managed\"]' MyExistingEC2Role/arn:aws:iam::aws:policy/AmazonEC2ReadOnlyAccess\n\necho \"Import completed. Running terraform plan...\"\nterraform plan\n```\n\n## Advanced Import Scenarios\n\n### Importing Complex Role with Inline Policies\n\n```bash\n# Get role with inline policies\naws iam get-role --role-name MyComplexRole\naws iam list-role-policies --role-name MyComplexRole\naws iam get-role-policy --role-name MyComplexRole --policy-name InlinePolicyName\n```\n\n```hcl\niam_roles = {\n  \"complex-role\" = {\n    name        = \"MyComplexRole\"\n    description = \"Complex role with inline policies\"\n    assume_role_policy = jsonencode({\n      # ... assume role policy\n    })\n    inline_policies = [\n      {\n        name = \"InlinePolicyName\"\n        policy = jsonencode({\n          # ... inline policy document\n        })\n      }\n    ]\n    tags = {\n      ImportedBy = \"terraform\"\n    }\n  }\n}\n```\n\n### Importing Cross-Account Trust Relationships\n\n```hcl\niam_roles = {\n  \"cross-account-role\" = {\n    name        = \"CrossAccountAccessRole\"\n    description = \"Role for cross-account access\"\n    assume_role_policy = jsonencode({\n      Version = \"2012-10-17\"\n      Statement = [\n        {\n          Effect = \"Allow\"\n          Principal = {\n            AWS = [\n              \"arn:aws:iam::111111111111:root\",\n              \"arn:aws:iam::222222222222:user/specific-user\"\n            ]\n          }\n          Action = \"sts:AssumeRole\"\n          Condition = {\n            StringEquals = {\n              \"sts:ExternalId\" = \"unique-external-id\"\n            }\n          }\n        }\n      ]\n    })\n  }\n}\n```\n\n### Importing Service-Linked Roles\n\n**Note**: Service-linked roles cannot be imported as they are managed by AWS services. Document them separately:\n\n```bash\n# List service-linked roles (for documentation)\naws iam list-roles --query 'Roles[?contains(RoleName, `AWSServiceRole`)].{RoleName:RoleName,ServiceLinkedRole:AssumeRolePolicyDocument}' --output table\n```\n\n## Import Validation Checklist\n\n### After Each Import\n- [ ] Run `terraform plan` to check for drift\n- [ ] Verify no unwanted changes are planned\n- [ ] Check that all policy documents match exactly\n- [ ] Validate that all trust relationships are correct\n- [ ] Ensure tags are properly applied\n\n### Policy-Specific Checks\n- [ ] Policy document JSON is properly formatted\n- [ ] All required permissions are included\n- [ ] No unintended permissions are added\n- [ ] Resource ARNs match your environment\n\n### Role-Specific Checks\n- [ ] Assume role policy matches existing\n- [ ] All attached policies are accounted for\n- [ ] Inline policies are included in configuration\n- [ ] Instance profiles are properly linked\n\n### Attachment-Specific Checks\n- [ ] All policy attachments are imported\n- [ ] Both managed and customer policies are handled\n- [ ] Group memberships are complete\n- [ ] Cross-references between resources work correctly\n\n## Common Import Issues and Solutions\n\n### Issue: Policy Document Formatting\n**Problem**: Policy import fails due to JSON formatting differences.\n**Solution**: Use `aws iam get-policy-version` to get the exact policy document format.\n\n```bash\n# Get properly formatted policy document\naws iam get-policy-version --policy-arn arn:aws:iam::123456789012:policy/MyPolicy --version-id v1 --query 'PolicyVersion.Document'\n```\n\n### Issue: Inline Policy Conflicts\n**Problem**: Terraform tries to create inline policies that already exist.\n**Solution**: Include all existing inline policies in the configuration.\n\n### Issue: Circular Dependencies\n**Problem**: Roles and policies reference each other creating circular dependencies.\n**Solution**: Import in the correct order:\n1. Policies first\n2. Roles second\n3. Attachments last\n\n### Issue: AWS Managed Policy References\n**Problem**: Confusion between customer-managed and AWS-managed policies.\n**Solution**: Use full ARNs for AWS-managed policies:\n\n```hcl\n# AWS managed policy\npolicy_arn = \"arn:aws:iam::aws:policy/AmazonS3ReadOnlyAccess\"\n\n# Customer managed policy\npolicy_key = \"my-custom-policy\"  # Reference to policy in this module\n```\n\n## Automated Import Script Template\n\n```bash\n#!/bin/bash\n# automated-iam-import.sh\n\nset -e\n\n# Configuration\nMODULE_NAME=\"iam_management\"\nACCOUNT_ID=\"123456789012\"\n\n# Function to import IAM policy\nimport_policy() {\n    local key=\"$1\"\n    local arn=\"$2\"\n    echo \"Importing policy: $key -> $arn\"\n    terraform import \"module.${MODULE_NAME}.aws_iam_policy.this[\\\"$key\\\"]\" \"$arn\"\n}\n\n# Function to import IAM role\nimport_role() {\n    local key=\"$1\"\n    local name=\"$2\"\n    echo \"Importing role: $key -> $name\"\n    terraform import \"module.${MODULE_NAME}.aws_iam_role.this[\\\"$key\\\"]\" \"$name\"\n}\n\n# Function to import role policy attachment\nimport_role_policy_attachment() {\n    local key=\"$1\"\n    local role_name=\"$2\"\n    local policy_arn=\"$3\"\n    echo \"Importing role policy attachment: $key -> $role_name/$policy_arn\"\n    terraform import \"module.${MODULE_NAME}.aws_iam_role_policy_attachment.this[\\\"$key\\\"]\" \"$role_name/$policy_arn\"\n}\n\n# Import policies\nimport_policy \"s3-policy\" \"arn:aws:iam::${ACCOUNT_ID}:policy/MyS3Policy\"\nimport_policy \"ec2-policy\" \"arn:aws:iam::${ACCOUNT_ID}:policy/MyEC2Policy\"\n\n# Import roles\nimport_role \"web-role\" \"MyWebServerRole\"\nimport_role \"api-role\" \"MyAPIServerRole\"\n\n# Import attachments\nimport_role_policy_attachment \"web-s3-access\" \"MyWebServerRole\" \"arn:aws:iam::${ACCOUNT_ID}:policy/MyS3Policy\"\nimport_role_policy_attachment \"api-ec2-access\" \"MyAPIServerRole\" \"arn:aws:iam::${ACCOUNT_ID}:policy/MyEC2Policy\"\n\necho \"All imports completed successfully!\"\necho \"Running terraform plan to verify...\"\nterraform plan\n```\n\nThis comprehensive approach ensures that all existing IAM resources are properly imported and managed by Terraform while maintaining their current functionality and relationships."